# kube-infra
# Terraform AWS Kubernetes Cluster Setup

This repository contains Terraform code to provision a self-managed Kubernetes cluster on AWS using EC2 Spot Instances. The infrastructure includes VPC, subnets, security groups, IAM roles, and EC2 worker nodes to run Kubernetes.

## Table of Contents
1. [Prerequisites](#prerequisites)
2. [Deploying the Cluster](#deploying-the-cluster)
3. [Accessing the Cluster](#accessing-the-cluster)
4. [Tearing Down the Infrastructure](#tearing-down-the-infrastructure)
5. [Notes](#notes)

## Prerequisites

Before running Terraform, make sure you have the following tools installed and configured:

1. **AWS CLI**: [Install AWS CLI](https://aws.amazon.com/cli/) and configure it with your credentials.
   ```bash
   aws configure


Terraform: Install Terraform.

kubectl: Install kubectl to interact with your Kubernetes cluster.

IAM Permissions: Make sure your AWS user has sufficient permissions to create EC2 instances, VPCs, IAM roles, security groups, etc.

Deploying the Cluster
Follow these steps to deploy the Kubernetes cluster on AWS using Terraform.

Step 1: Clone the Repository
Clone this repository to your local machine:

bash
Copy
Edit
git clone https://github.com/your-repo/k8s-terraform-aws.git
cd k8s-terraform-aws
Step 2: Initialize Terraform
Run the following command to initialize the Terraform provider and download the necessary modules:

bash
Copy
Edit
terraform init
Step 3: Validate the Terraform Configuration
Before applying the configuration, validate the Terraform files to ensure there are no errors:

bash
Copy
Edit
terraform validate
Step 4: Apply the Terraform Configuration
To deploy the Kubernetes cluster, run the following command:

bash
Copy
Edit
terraform apply
Terraform will show you a plan of what it will create. Type yes to confirm and proceed with the creation.

Step 5: Wait for the Deployment to Complete
Terraform will create the VPC, subnets, security groups, EC2 instances (worker nodes), and IAM roles. This process may take several minutes to complete.

Once completed, Terraform will output the relevant details for the cluster.

Step 6: Set Up Kubernetes (Using kubeadm or kOps)
You need to install Kubernetes on the EC2 instances. You can either use kubeadm or kOps. Here's how to do it with kubeadm:

SSH into the master node and initialize Kubernetes:

bash
Copy
Edit
kubeadm init --pod-network-cidr=10.244.0.0/16
After the initialization, copy the kubeconfig file to your local machine to configure kubectl:

bash
Copy
Edit
mkdir -p $HOME/.kube
sudo cp /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
On the worker nodes, run the command generated by kubeadm init to join the cluster:

bash
Copy
Edit
kubeadm join <master-node-ip>:6443 --token <token> --discovery-token-ca-cert-hash <hash>
Verify the nodes are joined:

bash
Copy
Edit
kubectl get nodes
Step 7: Install a Network Plugin
For your cluster to communicate between pods, you will need to install a network plugin like Flannel or Calico. Here is an example using Flannel:

bash
Copy
Edit
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
Step 8: Verify the Cluster
Once the network plugin is installed, verify that the Kubernetes cluster is up and running:

bash
Copy
Edit
kubectl get nodes
You should see your master node and worker nodes listed with Ready status.

Tearing Down the Infrastructure
To tear down the infrastructure created by Terraform, simply run the following command:

bash
Copy
Edit
terraform destroy
Terraform will show you a plan of what will be destroyed. Type yes to confirm and proceed with the destruction. This will delete all the resources, including:

VPC

EC2 instances

IAM roles and policies

Security groups

Subnets

EBS volumes

Notes:
IAM Permissions: Ensure that your AWS IAM user has sufficient permissions to delete the resources.

Costs: Be mindful that leaving resources like EC2 instances running could result in unnecessary costs. Use terraform destroy when you're done to avoid this.

Spot Instances: The Spot Instances used for worker nodes can be terminated by AWS with little notice, so this setup is more suited for stateless applications.

Additional Resources
AWS Terraform Provider Documentation

Kubernetes Installation Guide

Flannel Network Plugin

yaml
Copy
Edit
